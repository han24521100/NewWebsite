<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PminMod | Báo chí</title>
  <link rel="icon" href="ico.jpg" type="image/x-icon" />
  <style>
    :root{
      --bg:#ffdde8;--card:#1b1b1b;--cardSoft:#232323;--accentSoft:#ffb6d2;
      --text:#f5f5f7;--muted:#c9c9d1;--chip:#2b2b2b;--radius:14px;
      --shadow:0 10px 25px rgba(0,0,0,.25)
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{font-family:system-ui,"Segoe UI",Roboto,Arial;background:var(--bg);color:#4a0033;margin:0;padding:0 0 60px}
    .bg-video{position:fixed;inset:0;width:100%;height:100%;object-fit:cover;z-index:-1;opacity:.18;pointer-events:none}
    header{max-width:1200px;margin:28px auto 10px;padding:0 16px;text-align:center}
    .brand{display:inline-flex;align-items:center;gap:12px;background:rgba(255,255,255,.7);padding:10px 14px;border-radius:999px;backdrop-filter:blur(8px);box-shadow:var(--shadow)}
    .avatar{width:44px;height:44px;border-radius:50%;border:3px solid #fff;object-fit:cover;background:#fff}
    h1{margin:10px 0 6px;font-size:clamp(22px,2.4vw,32px)}
    p.sub{margin:0 auto;max-width:800px;color:#7a0033}
    .toolbar{max-width:1200px;margin:18px auto 0;padding:0 16px;display:grid;grid-template-columns:1fr auto;gap:10px}
    .search{display:flex;align-items:center;gap:10px;background:#fff;border-radius:10px;padding:10px 12px;box-shadow:var(--shadow)}
    .search input{width:100%;border:0;outline:0;font-size:16px;color:#222;background:transparent}
    .count{align-self:center;font-size:14px;color:#4a0033;opacity:.8;background:#ffd0e1;padding:8px 12px;border-radius:999px;box-shadow:var(--shadow)}
    .grid{max-width:1200px;margin:16px auto 0;padding:0 16px;display:grid;gap:18px;grid-template-columns:repeat(1,minmax(0,1fr))}
    @media(min-width:600px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media(min-width:1000px){.grid{grid-template-columns:repeat(3,1fr)}}
    .card{background:var(--card);color:var(--text);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);display:flex;flex-direction:column;border:1px solid rgba(255,255,255,.06);transition:transform .15s ease,box-shadow .2s ease}
    .card:hover{transform:translateY(-2px);box-shadow:0 16px 35px rgba(0,0,0,.35)}
    .thumb{position:relative;background:#0e0e0e;aspect-ratio:16/9;overflow:hidden}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .badge{position:absolute;left:10px;top:10px;background:linear-gradient(135deg,#ff5fb7,#ff326f);padding:6px 10px;border-radius:999px;font-size:12px;font-weight:700;box-shadow:0 6px 16px rgba(255,80,150,.35)}
    .body{padding:14px 14px 0;display:flex;flex-direction:column;gap:10px}
    .title{font-weight:700;font-size:16px;line-height:1.3;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}
    .meta{display:flex;flex-wrap:wrap;gap:8px}
    .chip{font-size:12px;color:#e8e8ef;background:var(--chip);padding:6px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.06)}
    .info{color:var(--muted);font-size:14px;background:var(--cardSoft);padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.06);min-height:62px}
    .footer{display:flex;align-items:center;justify-content:space-between;padding:12px 14px 14px;gap:10px}
    .btn{appearance:none;border:0;cursor:pointer;padding:10px 14px;border-radius:10px;font-weight:700;font-size:14px;display:inline-flex;align-items:center;gap:8px;text-decoration:none}
    .btn-outline{color:#fff;background:transparent;border:1px solid #3a3a3a}
    .btn-primary{color:#1b0a14;background:var(--accentSoft)}
    .skeleton{position:relative;overflow:hidden;background:#2a2a2a}
    .skeleton::after{content:"";position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.06),transparent);animation:shimmer 1.1s infinite}
    @keyframes shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
    .note{max-width:1000px;margin:28px auto 0;padding:0 16px;color:#77003f;text-align:center}
    .card { cursor: pointer; }
    .card:focus { outline: 3px solid #ffa0c2; outline-offset: 3px; }
    .search-col{display:flex;flex-direction:column;gap:8px}
    .filters{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .filters .tab{background:transparent;border:0;color:#4a0033;padding:6px 10px;border-radius:999px;font-weight:800;cursor:pointer}
    .filters .tab.active{background:#ffd0e1;box-shadow:var(--shadow)}
    .filters .tab:hover{background:#ffebf2}
  </style>
</head>
<body>
  <video class="bg-video" autoplay muted loop playsinline>
    <source src="bg.mp4" type="video/mp4"/>
  </video>

  <header>
    <div class="brand">
      <img class="avatar" src="ico.jpg" alt="Logo"/>
      <div>
        <div style="font-weight:800;color:#4a0033">PminMod • Bản tin</div>
        <small style="color:#7a0033">Bấm để xem chi tiết bài viết</small>
      </div>
    </div>
    <h1>Danh sách bài viết</h1>
    <p class="sub">Tự động sinh thẻ từ <code>news.json</code> (key là <i>slug</i> như <code>mod-1</code>).</p>
  </header>

  <div class="toolbar">
    <div class="search-col">
      <div class="filters" id="filters">
        <button class="tab" data-abc="">Tất cả</button>
        <button class="tab" data-abc="yeu-cau">Yêu cầu</button>
        <button class="tab" data-abc="mod-bth">Mod bình thường</button>
        <button class="tab" data-abc="chuc-nang">Chức năng</button>
      </div>
      <div class="search">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.2-4.2m1.7-5.3a7 7 0 11-14 0 7 7 0 0114 0z" stroke="#222" stroke-width="2" stroke-linecap="round"/></svg>
        <input id="q" placeholder="Tìm bài viết... (tiêu đề, tóm tắt)" />
      </div>
    </div>
    <div class="count"><span id="count">0</span> bài viết</div>
  </div>

  <main class="grid" id="grid"></main>
  <p class="note">Click mở trang: <code>product.html?pminmod=&lt;slug&gt;</code></p>

  <script>
    const JSON_PATH = 'news.json';
    const REFRESH_WINDOW = 60_000; // 1 phút
    const bust = Math.floor(Date.now() / REFRESH_WINDOW);

    // ====== helpers DOM ======
    const $ = (s, r=document)=>r.querySelector(s);
    const grid = $('#grid'), q = $('#q'), countEl = $('#count'), filtersEl = $('#filters');

    // ====== phân loại theo [ ... ] trong title ======
    const CAT_LABEL = { 'yeu-cau':'Yêu cầu', 'mod-bth':'Mod bình thường', 'chuc-nang':'Chức năng' };
    const VALID = new Set(Object.keys(CAT_LABEL));
    function rmAccents(str){ return String(str||'').normalize('NFD').replace(/[\u0300-\u036f]/g,''); }
    function getCategoryFromTitle(title){
      const m = /\[([^\]]+)\]/.exec(String(title||''));
      if (!m) return 'chuc-nang'; // không có ngoặc
      const inside = rmAccents(m[1]).toLowerCase();
      return inside.includes('yeu') ? 'yeu-cau' : 'mod-bth';
    }

    function skeletonCard(){
      const wrap = document.createElement('article');
      wrap.className='card';
      wrap.innerHTML=`
        <div class="thumb skeleton"></div>
        <div class="body">
          <div class="title skeleton" style="height:22px;border-radius:8px;"></div>
          <div class="meta" style="gap:6px;">
            <div class="skeleton" style="height:22px;width:90px;border-radius:999px;"></div>
            <div class="skeleton" style="height:22px;width:120px;border-radius:999px;"></div>
          </div>
          <div class="info skeleton" style="height:64px;border-radius:10px;"></div>
        </div>
        <div class="footer">
          <div class="skeleton" style="height:38px;width:130px;border-radius:10px;"></div>
          <div class="skeleton" style="height:38px;width:120px;border-radius:10px;"></div>
        </div>`;
      return wrap;
    }
    function toTitle(slug){ return String(slug || '').replace(/[-_]/g,' ').trim(); }

    // đọc json → list
    function fromJSON(obj){
      return Object.entries(obj).map(([slug, v = {}]) => {
        const title = v.title ? String(v.title) : toTitle(slug);
        return {
          slug,
          title,
          cat: getCategoryFromTitle(title),
          img: v.img || 'ico.jpg',
          info: v.info ? String(v.info) : '',
          href: `product.html?pminmod=${encodeURIComponent(slug)}`
        };
      });
    }

    function render(list){
      grid.innerHTML='';
      list.forEach((it, idx)=>{
        const card = document.createElement('article');
        card.className='card';
        card.innerHTML=`
          <div class="thumb">
            <img loading="lazy" src="${it.img}" alt="${it.title}">
            <div class="badge">Bài #${String(idx+1).padStart(2,'0')}</div>
          </div>
          <div class="body">
            <div class="title">${it.title}</div>
            <div class="meta">
              <span class="chip">${CAT_LABEL[it.cat] || it.cat}</span>
              <span class="chip">Đọc chi tiết</span>
            </div>
            <div class="info">${it.info}</div>
          </div>
          <div class="footer">
            <a class="btn btn-outline" href="${it.href}">Xem chi tiết</a>
            <a class="btn btn-primary" href="${it.href}">Đọc ngay</a>
          </div>`;

        // Cả card bấm được
        card.dataset.href = it.href;
        card.setAttribute('role','link');
        card.tabIndex = 0;
        card.addEventListener('click', e => { if (!e.target.closest('a')) location.href = card.dataset.href; });
        card.addEventListener('keydown', e => { if (e.key==='Enter'||e.key===' ') { e.preventDefault(); location.href = card.dataset.href; } });

        grid.appendChild(card);
      });
      countEl.textContent = list.length;
    }

    // ====== state + filter ======
    let MASTER = [], currentAbc = '', currentKW = '';

    function setActiveTab(val){
      [...filtersEl.querySelectorAll('.tab')].forEach(b=>{
        b.classList.toggle('active', (b.dataset.abc || '') === (val || ''));
      });
    }

    function computeFiltered(){
      let arr = MASTER.slice();
      if (currentAbc && VALID.has(currentAbc)) arr = arr.filter(x => x.cat === currentAbc);
      if (currentKW){
        const kw = currentKW.toLowerCase();
        arr = arr.filter(x => x.title.toLowerCase().includes(kw) || x.info.toLowerCase().includes(kw));
      }
      return arr;
    }

    function applyAndRender(){
      render(computeFiltered());
    }

    // UI events
    q.addEventListener('input', ()=>{
      currentKW = q.value.trim().toLowerCase();
      applyAndRender();
    });

    filtersEl.addEventListener('click', (e)=>{
      const btn = e.target.closest('[data-abc]');
      if (!btn) return;
      currentAbc = (btn.dataset.abc || '');
      setActiveTab(currentAbc);
      // cập nhật URL ?abc=
      const params = new URLSearchParams(location.search);
      if (currentAbc) params.set('abc', currentAbc); else params.delete('abc');
      const qs = params.toString();
      history.replaceState({}, '', qs ? `${location.pathname}?${qs}` : location.pathname);
      applyAndRender();
    });

    // ====== load ======
    async function load(){
      grid.innerHTML=''; for(let i=0;i<6;i++) grid.appendChild(skeletonCard());
      try{
        const url = new URL(JSON_PATH, location.href);
        url.searchParams.set('t', bust);
        const res = await fetch(url, { cache:'no-store' });
        const data = await res.json();
        MASTER = fromJSON(data);

        // đọc abc ban đầu từ URL
        const p = new URLSearchParams(location.search);
        const abc0 = (p.get('abc') || '').toLowerCase();
        currentAbc = VALID.has(abc0) ? abc0 : '';
        setActiveTab(currentAbc);

        applyAndRender();
      }catch(e){
        MASTER = [];
        applyAndRender();
      }
    }
    load();
  </script>

</body>
</html>
